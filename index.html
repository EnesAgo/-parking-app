<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Meta</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="header">
    <div class="logo">Parking Meta</div>
    <button class="button" id="scan">Scan</button>
    <button class="button" onclick="scannerButtonChange(true)" id="closeScanner" style="display: none">Cancel</button>
</div>

<div class="button-container" id="buttonContainer">
    <button class="button" onclick="startTransaction(1)">1hr</button>
    <button class="button" onclick="startTransaction(2)">2hrs</button>
    <button class="button" onclick="startTransaction(3)">3hrs</button>
    <button class="button" onclick="showCustomInput()">Custom</button>
    <div id="customInput" style="display: none;">
        <input type="number" id="customHours" placeholder="Enter hours">
        <button class="button" onclick="startCustomTransaction()">Create</button>
    </div>
</div>

<div id="reader" class="none" style="width: 400px;"></div>
<div id="modal" class="popup" style="display: none;">
    <button onclick="closePopup()" id="close-btn">x</button>
    <div id="ticketContent"></div>
</div>

<script>
    const { ipcRenderer } = require('electron');
    const { Html5Qrcode } = require("html5-qrcode");
    const QRCode = require("qrcode");

    let html5QrCode;

    function generateQRCode(qrID) {
        console.log("Generating QR code for ID:", qrID);
        return new Promise((resolve, reject) => {
            QRCode.toString(qrID, { type: 'svg' }, (err, svg) => {
                if (err) {
                    console.error('Error generating QR code:', err);
                    reject(err);
                } else {
                    console.log("QR code generated successfully:", svg);
                    resolve(svg);
                }
            });
        });
    }

    function closePopup() {
        document.getElementById('modal').style.display = 'none';
    }

    function stopQrCodeScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                console.log("QR Code scanner stopped.");
                html5QrCode = null;
            }).catch((err) => {
                console.error("Error stopping QR Code scanner:", err);
            });
        }
    }

    document.getElementById("scan").addEventListener('click', () => {
        scannerButtonChange(false);
        stopQrCodeScanner();

        ipcRenderer.on('get-transaction-reply', (event, response) => {
            if (response.success) {
                const { ticketExpired, hoursExpired, extraCharge } = response.transaction;

                const expiryStatus = ticketExpired ?
                    `Expired ${hoursExpired} hour${hoursExpired > 1 ? 's' : ''}` :
                    `Valid until ${response.transaction.expires_at.split(' ')[1]}`;

                document.getElementById('modal').style.display = 'flex';
                document.getElementById('ticketContent').innerHTML =
                    `<h1>Parking Meta</h1>
                    <h3>Date: ${(() => {
                        const date = new Date(response.transaction.created_at);
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = date.getFullYear();
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        const seconds = String(date.getSeconds()).padStart(2, '0');
                        return `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;
                    })()}</h3>
                    <div class="box"></div>
                    <h3>Time Created: ${response.transaction.created_at.split(' ')[1]}</h3>
                    <h3>Duration: ${response.transaction.duration} hour${response.transaction.duration > 1 ? 's' : ''}</h3>
                    <h3>Expiring At: ${expiryStatus}</h3>
                    <h3 class="${!ticketExpired ? 'none' : ''}">Extra Charge: ${extraCharge} den (${hoursExpired} hours)</h3>`;
            } else {
                console.error("Error fetching transaction:", response.error);
            }
        });

        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            ipcRenderer.send('get-transaction', { id: parseInt(decodedText) });
        };

        const config = { fps: 10, qrbox: 250 };
        html5QrCode = new Html5Qrcode("reader");

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            qrCodeSuccessCallback
        ).catch(err => {
            console.error(`Unable to start scanning, error: ${err}`);
        });
    });

    function scannerButtonChange(isOpen) {
        if (isOpen) {
            document.getElementById("scan").style.display = "block";
            document.getElementById("closeScanner").style.display = "none";
            document.getElementById("buttonContainer").style.display = "flex";
            document.getElementById("reader").classList.add("none");
            stopQrCodeScanner();
            return;
        }
        document.getElementById("scan").style.display = "none";
        document.getElementById("closeScanner").style.display = "block";
        document.getElementById("buttonContainer").style.display = "none";
        document.getElementById("reader").classList.remove("none");
    }

    function startTransaction(duration) {
        const expiresAt = new Date();
        expiresAt.setHours(expiresAt.getHours() + duration);

        ipcRenderer.send('store-transaction', { duration, expiresAt });

        ipcRenderer.once('store-transaction-reply', (event, response) => {
            printTicket(duration, new Date(), expiresAt, response.id.toString());
        });

        closeCustomTransaction();
    }

    async function printTicket(duration, createdAt, expiresAt, qrID) {
        const formattedCreatedAt = formattedDateTime(createdAt);
        const formattedExpiresAt = formattedDateTime(expiresAt);
        const dateToday = formattedDate(createdAt);

        try {
            const qrCodeSvg = await generateQRCode(qrID);

            const ticketContent =
                `<h1>Parking Meta</h1>
                <h3 style="text-align: center">${dateToday}</h3>
                <div class="box">${qrCodeSvg}</div>
                <h3>Time Created: ${formattedCreatedAt}</h3>
                <h3>Duration: ${duration} hour${duration > 1 ? 's' : ''}</h3>
                <h3>Expiring At: ${formattedExpiresAt}</h3>`;

            document.getElementById('modal').style.display = 'flex';
            document.getElementById('ticketContent').innerHTML = ticketContent;

            document.getElementById('modal').style.height = '450px';
            document.getElementById('close-btn').style.display = 'none';
            document.getElementById('close-btn').style.width = '300px';

            setTimeout(() => {
                closePopup();
                document.getElementById('modal').style.height = '300px';
                document.getElementById('close-btn').style.display = 'block';
            }, 1000);
        } catch (e) {
            console.error('Error generating QR code:', e);
        }
    }

    function formattedDateTime(date) {
        return `${date.getHours()}:${padZero(date.getMinutes())}`;
    }

    function formattedDate(date) {
        return `${padZero(date.getDate())}.${padZero(date.getMonth() + 1)}.${date.getFullYear()}`;
    }

    function padZero(num) {
        return (num < 10 ? '0' : '') + num;
    }

    function showCustomInput() {
        document.getElementById('customInput').style.display = 'flex';
        document.querySelector('.button-container button:nth-last-child(2)').style.display = 'none';

        document.querySelectorAll('.button-container button').forEach(button => {
            if (button.textContent !== 'Custom') {
                button.addEventListener('click', closeCustomTransaction);
            }
        });
    }

    function startCustomTransaction() {
        const customHours = document.getElementById('customHours').value;
        const expiresAt = new Date();
        expiresAt.setHours(expiresAt.getHours() + parseInt(customHours));

        ipcRenderer.send('store-transaction', { duration: customHours, expiresAt });

        ipcRenderer.once('store-transaction-reply', (event, response) => {
            printTicket(customHours, new Date(), expiresAt, response.id.toString());
        });

        closeCustomTransaction();
    }

    function closeCustomTransaction() {
        document.getElementById('customInput').style.display = 'none';
        document.querySelector('.button-container button:nth-last-child(2)').style.display = 'block';
    }
</script>
</body>
</html>
